/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
* Copyright 2022 Adobe
* All Rights Reserved.
*
* NOTICE: All information contained herein is, and remains
* the property of Adobe and its suppliers, if any. The intellectual
* and technical concepts contained herein are proprietary to Adobe
* and its suppliers and are protected by all applicable intellectual
* property laws, including trade secret and copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe.

* Adobe permits you to use and modify this file solely in accordance with
* the terms of the Adobe license agreement accompanying it.
*************************************************************************/

import{propertyChange as e,ExecuteRule as t,Initialize as n,CustomEvent as i,Submit as s,RemoveInstance as r,AddInstance as o,Reset as a,RemoveItem as l,AddItem as u,Click as h,Change as d,FormLoad as c,FieldChanged as p,ValidationComplete as m,Valid as f,Invalid as g}from"./afb-events.min.js";import _ from"../formula/index.min.js";import{format as y,parseDateSkeleton as v,formatDate as b}from"./afb-formatters.min.js";class M{$_name;$_value;$_type;$_fields=[];constructor(e,t,n=typeof t){this.$_name=e,this.$_value=t,this.$_type=n}valueOf(){return this.$_value}get $name(){return this.$_name}get $value(){if(this.$_fields.find((e=>!1!==e.enabled))||!this.$_fields.length)return this.$_value}setValue(e,t,n){this.$_value=e,this.$_fields.forEach((e=>{n!==e&&(e.value=t)}))}get $type(){return this.$_type}$bindToField(e){-1===this.$_fields.indexOf(e)&&this.$_fields.push(e)}$convertToDataValue(){return this}get $isDataGroup(){return!1}}const j=Symbol("NullValue");const x=new class extends M{constructor(){super("",j,"null")}setValue(){}$bindToField(){}$length(){return 0}$convertToDataValue(){return this}$addDataNode(){}$removeDataNode(){}$getDataNode(){return this}$containsDataNode(){return!1}};class $ extends M{$_items;createEntry(e,t){const n=t instanceof Array?"array":typeof t;return"object"==typeof t&&null!=t?new $(e,t,n):new M(e,t,n)}constructor(e,t,n=typeof t){super(e,t,n),this.$_items=t instanceof Array?t.map(((e,t)=>this.createEntry(t,e))):Object.fromEntries(Object.entries(t).map((([e,t])=>[e,this.createEntry(e,t)])))}get $value(){return!this.$_fields.find((e=>!1!==e.enabled))&&this.$_fields.length?"array"===this.$type?[]:{}:"array"===this.$type?Object.values(this.$_items).filter((e=>void 0!==e)).map((e=>e.$value)):Object.fromEntries(Object.values(this.$_items).filter((e=>void 0!==e)).map((e=>[e.$name,e.$value])))}get $length(){return Object.entries(this.$_items).length}$convertToDataValue(){return new M(this.$name,this.$value,this.$type)}$addDataNode(e,t,n=!1){if(t!==x)if("array"===this.$type){const i=e;n?this.$_items[e]=t:this.$_items.splice(i,0,t)}else this.$_items[e]=t}$removeDataNode(e){this.$_items[e]=void 0}$getDataNode(e){if(this.$_items.hasOwnProperty(e))return this.$_items[e]}$containsDataNode(e){return this.$_items.hasOwnProperty(e)&&void 0!==this.$_items[e]}get $isDataGroup(){return!0}}const E="Identifier",w="Global",D="bracket",N=(e,t)=>({type:E,value:e,start:t}),T=function(e){return e>="a"&&e<="z"||e>="A"&&e<="Z"||e>="0"&&e<="9"||"_"===e},O=(e,t,n)=>null===e&&"$"===t[n],k=(e,t)=>{const n=e[t];return"$"===n?e.length>t&&T(e[t+1]):n>="a"&&n<="z"||n>="A"&&n<="Z"||"_"===n},I=e=>e>="0"&&e<="9";class R{stream;_current;_tokens=[];_result_tokens=[];constructor(e){this.stream=e,this._current=0}_consumeGlobal(){return this._current+=1,{type:w,start:0,value:"$"}}_consumeUnquotedIdentifier(e){const t=this._current;for(this._current+=1;this._current<e.length&&T(e[this._current]);)this._current+=1;return N(e.slice(t,this._current),t)}_consumeQuotedIdentifier(e){const t=this._current;this._current+=1;const n=e.length;for(;'"'!==e[this._current]&&this._current<n;){let t=this._current;"\\"!==e[t]||"\\"!==e[t+1]&&'"'!==e[t+1]?t+=1:t+=2,this._current=t}return this._current+=1,N(JSON.parse(e.slice(t,this._current)),t)}_consumeNumber(e){const t=this._current;this._current+=1;const n=e.length;for(;I(e[this._current])&&this._current<n;)this._current+=1;const i=e.slice(t,this._current);return{type:"Number",value:parseInt(i,10),start:t}}_consumeBracket(e){const t=this._current;let n;if(this._current+=1,!I(e[this._current]))throw new Error(`unexpected exception at position ${this._current}. Must be a character`);if(n=this._consumeNumber(e).value,this._current<this.stream.length&&"]"!==e[this._current])throw new Error(`unexpected exception at position ${this._current}. Must be a character`);return this._current++,((e,t)=>({type:D,value:e,start:t}))(n,t)}tokenize(){const e=this.stream;for(;this._current<e.length;){const t=this._tokens.length?this._tokens.slice(-1)[0]:null;if(O(t,e,this._current)){const e=this._consumeGlobal();this._tokens.push(e),this._result_tokens.push(e)}else if(k(e,this._current)){const t=this._consumeUnquotedIdentifier(e);this._tokens.push(t),this._result_tokens.push(t)}else if("."===e[this._current]&&null!=t&&"DOT"!==t.type)this._tokens.push({type:"DOT",value:".",start:this._current}),this._current+=1;else if("["===e[this._current]){const t=this._consumeBracket(e);this._tokens.push(t),this._result_tokens.push(t)}else{if('"'!==e[this._current]){const e=Math.max(0,this._current-2),t=Math.min(this.stream.length,this._current+2);throw new Error(`Exception at parsing stream ${this.stream.slice(e,t)}`)}{const t=this._consumeQuotedIdentifier(e);this._tokens.push(t),this._result_tokens.push(t)}}}return this._result_tokens}}const F=e=>new R(e).tokenize(),C=(e,t,n)=>{let i;i="string"==typeof t?F(t):t;let s=e,r=0;const o=(e,t,n)=>null===t?n:t.type===D?new $(e.value,[],"array"):new $(e.value,{});for(;r<i.length&&null!=s;){const t=i[r];if(t.type===w)s=e;else if(t.type===E){if(!(s instanceof $&&"object"===s.$type))throw new Error(`Looking for ${t.value} in ${s.$value}`);if(s.$containsDataNode(t.value)&&null!==s.$getDataNode(t.value).$value)s=s.$getDataNode(t.value);else if(n){const e=o(t,r<i.length-1?i[r+1]:null,n);s.$addDataNode(t.value,e),s=e}else s=void 0}else if(t.type===D){if(!(s instanceof $&&"array"===s.$type))throw new Error(`Looking for index ${t.value} in non array${s.$value}`);{const e=t.value;if(e<s.$length)s=s.$getDataNode(e);else if(n){const a=o(t,r<i.length-1?i[r+1]:null,n);s.$addDataNode(e,a),s=a}else s=void 0}}r+=1}return s};function P(e,t,n,i){var s,r=arguments.length,o=r<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,n):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,i);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(r<3?s(o):r>3?s(t,n,o):s(t,n))||o);return r>3&&o&&Object.defineProperty(t,n,o),o}const S=["value","label","description","visible","enabled","readOnly","enum","enumNames","required","properties","exclusiveMinimum","exclusiveMaximum","maximum","maxItems","minimum","minItems"],q=[...S,"valid","index","activeChild"],A=["plain-text","image"];class z{_action;_target;constructor(e,t){this._action=e,this._target=t}get type(){return this._action.type}get payload(){return this._action.payload}get metadata(){return this._action.metadata}get target(){return this._target}get isCustomEvent(){return this._action.isCustomEvent}get originalAction(){return this._action.originalAction}toString(){return this._action.toString()}}const V=Symbol("target"),U=Symbol("qualifiedName");const L=e=>(...t)=>(n,i,s)=>{const r=s.get;null!=r&&(s.get=function(){if(t.indexOf(this.fieldType)>-1===e)return r.call(this)});const o=s.set;null!=o&&(s.set=function(n){t.indexOf(this.fieldType)>-1===e&&o.call(this,n)})},Q=L(!0),W=L(!1);class B{_options;_ruleNode;_lang="";_callbacks={};_dependents=[];_jsonModel;_tokens=[];get isContainer(){return!1}constructor(e,t){this._options=t,this[U]=null,this._jsonModel={...e,id:"id"in e?e.id:this.form.getUniqueId()}}setupRuleNode(){const e=this;this._ruleNode=new Proxy(this.ruleNodeReference(),{get:(t,n)=>e.getFromRule(t,n)})}ruleNodeReference(){return this}getRuleNode(){return this._ruleNode}getFromRule(e,t){if(t===Symbol.toPrimitive||"valueOf"===t&&!e.hasOwnProperty("valueOf"))return this.valueOf;if(t===V)return this;if("string"==typeof t)if(t.startsWith("$")){if("function"!=typeof this[t=t.substr(1)]){const e=this[t];return e instanceof B?e.getRuleNode():e instanceof Array?e.map((e=>e instanceof B?e.getRuleNode():e)):e}}else{if(e.hasOwnProperty(t))return e[t];if("function"==typeof e[t])return e[t]}}get id(){return this._jsonModel.id}get index(){return this.parent?this.parent.indexOf(this):0}get parent(){return this._options.parent}get type(){return this._jsonModel.type}get repeatable(){return this.parent?.hasDynamicItems()}get fieldType(){return this._jsonModel.fieldType||"text-input"}get":type"(){return this._jsonModel[":type"]||this.fieldType}get name(){return this._jsonModel.name}get description(){return this._jsonModel.description}set description(e){this._setProperty("description",e)}get dataRef(){return this._jsonModel.dataRef}get visible(){return this._jsonModel.visible}set visible(t){if(t!==this._jsonModel.visible){const n=e("visible",t,this._jsonModel.visible);this._jsonModel.visible=t,this.notifyDependents(n)}}get form(){return this._options.form}get ruleEngine(){return this.form.ruleEngine}get label(){return this._jsonModel.label}set label(t){if(t!==this._jsonModel.label){const n=e("label",t,this._jsonModel.label);this._jsonModel={...this._jsonModel,label:t},this.notifyDependents(n)}}get uniqueItems(){return this._jsonModel.uniqueItems}isTransparent(){const e="array"===this.parent?._jsonModel.type;return!this._jsonModel.name&&!e}getState(){return{...this._jsonModel,properties:this.properties,index:this.index,parent:void 0,qualifiedName:this.qualifiedName,events:{},rules:{},repeatable:!0===this.repeatable||void 0,":type":this[":type"]}}subscribe(e,t="change"){return this._callbacks[t]=this._callbacks[t]||[],this._callbacks[t].push(e),{unsubscribe:()=>{this._callbacks[t]=this._callbacks[t].filter((t=>t!==e))}}}_addDependent(e){if(void 0===this._dependents.find((({node:t})=>t===e))){const n=this.subscribe((n=>{const i=n.payload.changes,s=[...q,"items"];i.findIndex((e=>s.indexOf(e.propertyName)>-1))>-1&&e.dispatch(new t)}));this._dependents.push({node:e,subscription:n})}}removeDependent(e){const t=this._dependents.findIndex((({node:t})=>t===e));t>-1&&(this._dependents[t].subscription.unsubscribe(),this._dependents.splice(t,1))}queueEvent(e){const t=new z(e,this);this.form.getEventQueue().queue(this,t,["valid","invalid"].indexOf(t.type)>-1)}dispatch(e){this.queueEvent(e),this.form.getEventQueue().runPendingQueue()}notifyDependents(e){(this._callbacks[e.type]||[]).forEach((t=>{t(new z(e,this))}))}_setProperty(t,n,i=!0){const s=this._jsonModel[t];let r=!1;if(r=null!==n&&null!==s&&"object"==typeof n&&"object"==typeof s?JSON.stringify(n)===JSON.stringify(s):s===n,!r){this._jsonModel[t]=n;const r=e(t,n,s);return i&&this.notifyDependents(r),r.payload.changes}return[]}_bindToDataModel(e){if("$form"===this.id)return void(this._data=e);const t=this._jsonModel.dataRef;let n,i=e,s="";if(null===t)n=x;else if(void 0!==t){0===this._tokens.length&&(this._tokens=F(t));let r=e;if(this._tokens[0].type===w&&(r=this.form.getDataNode()),void 0!==r){const e=this._tokens[this._tokens.length-1].value,t=this.defaultDataModel(e);n=C(r,this._tokens,t),i=C(r,this._tokens.slice(0,-1)),s=e}}else if(e!==x&&-1===A.indexOf(this.fieldType)){i=e;const t=this._jsonModel.name||"",r="array"===e.$type?this.index:t;if(s=r,""!==r){const t=this.defaultDataModel(r);void 0!==t&&(n=e.$getDataNode(r),void 0===n&&(n=t,e.$addDataNode(r,n)))}else n=void 0}n&&(this.isContainer||i===x||n===x||(n=n?.$convertToDataValue(),i.$addDataNode(s,n,!0)),n?.$bindToField(this),this._data=n)}_data;getDataNode(){return this._data}get language(){return this._lang||(this.parent?this._lang=this.parent.language:this._lang=Intl.DateTimeFormat().resolvedOptions().locale),this._lang}get properties(){return this._jsonModel.properties||{}}set properties(e){this._setProperty("properties",{...e})}getNonTransparentParent(){let e=this.parent;for(;null!=e&&e.isTransparent();)e=e.parent;return e}_initialize(){if(void 0===this._data){let e,t=this.parent;do{e=t.getDataNode(),t=t.parent}while(void 0===e);this._bindToDataModel(e)}}_applyUpdates(e,t){return e.reduce(((e,n)=>{const i=t[n],s=this._setProperty(n,i,!1);return s.length>0&&(e[n]=s[0]),e}),{})}get qualifiedName(){if(this.isTransparent())return null;if(null!==this[U])return this[U];const e=this.getNonTransparentParent();return e&&"array"===e.type?this[U]=`${e.qualifiedName}[${this.index}]`:this[U]=`${e.qualifiedName}.${this.name}`,this[U]}focus(){this.parent&&(this.parent.activeChild=this)}}P([function(e,t,n){const i=n.get;null!=i&&(n.get=function(){return this.ruleEngine.trackDependency(this),i.call(this)})}],B.prototype,"index",null),P([function(e,t,n){const i=n.get;null!=i&&(n.get=function(){return this.ruleEngine.trackDependency(this),i.call(this)})}],B.prototype,"description",null),P([function(e,t,n){const i=n.get;null!=i&&(n.get=function(){return this.ruleEngine.trackDependency(this),i.call(this)})}],B.prototype,"visible",null),P([function(e,t,n){const i=n.get;null!=i&&(n.get=function(){return this.ruleEngine.trackDependency(this),i.call(this)})}],B.prototype,"label",null),P([function(e,t,n){const i=n.get;null!=i&&(n.get=function(){return this.ruleEngine.trackDependency(this),i.call(this)})}],B.prototype,"properties",null);const G=e=>new Map(Object.entries(e)),J=G({date:"date-input","data-url":"file-input",binary:"file-input"}),K=G({number:"number-input",boolean:"checkbox",object:"panel",array:"panel",file:"file-input","file[]":"file-input"}),X=["string[]","boolean[]","number[]","array"],Y=e=>{const t=e.type||"string";if("enum"in e){return e.enum.length>2||X.indexOf(t)>-1?"drop-down":"checkbox"}return"string"===t||"string[]"===t?J.get(e.format)||"text-input":K.get(t)||"text-input"},Z=function(e){return"file"===e?.type||"file[]"===e?.type||("string"===e?.type||"string[]"===e?.type)&&("binary"===e?.format||"data-url"===e?.format)};function H(e,t){let n;return e instanceof Array?(n=[],n=e.map((e=>H(e,t)))):"object"==typeof e&&null!==e?(n={},Object.entries(e).forEach((([e,i])=>{n[e]=H(i,t)}))):n=e,t&&n&&n.id&&(n.id=t()),n}const ee=e=>JSON.stringify(e,null,2);class te extends B{_events={};_rules={};getRules(){return"object"!=typeof this._jsonModel.rules?{}:this._jsonModel.rules}getCompiledRule(e,t){if(!(e in this._rules)){const n=t||this.getRules()[e];if(!("string"==typeof n&&n.length>0))throw new Error(`only expression strings are supported. ${typeof n} types are not supported`);try{this._rules[e]=this.ruleEngine.compileRule(n)}catch(t){this.form.logger.error(`Unable to compile rule \`"${e}" : "${n}"\` Exception : ${t}`)}}return this._rules[e]}getCompiledEvent(e){if(!(e in this._events)){let t=this._jsonModel.events?.[e];"string"==typeof t&&t.length>0&&(t=[t]),void 0!==t&&t.length>0&&(this._events[e]=t.map((n=>{try{return this.ruleEngine.compileRule(n)}catch(n){this.form.logger.error(`Unable to compile expression \`"${e}" : "${t}"\` Exception : ${n}`)}return null})).filter((e=>null!==e)))}return this._events[e]||[]}applyUpdates(e){Object.entries(e).forEach((([e,t])=>{if(e in S||e in this&&"function"!=typeof this[e])try{this[e]=t}catch(e){console.error(e)}}))}executeAllRules(e){const t=Object.entries(this.getRules());if(t.length>0){const n=this.getExpressionScope();t.forEach((([t,i])=>{const s=this.getCompiledRule(t,i);if(s){const i=this.ruleEngine.execute(s,n,e,!0);S.indexOf(t)>-1?this[t]=i:this.form.logger.warn(`${t} is not a valid editable property.`)}}))}}getExpressionScope(){const e=this.getNonTransparentParent(),t={self:this.getRuleNode(),siblings:e?.ruleNodeReference()||{}},n=new Proxy(t,{get:(e,t)=>{if(t===Symbol.toStringTag)return"Object";if(t.startsWith("$")){const n=e.self[t];return n instanceof B?n.getRuleNode():n instanceof Array?n.map((e=>e instanceof B?e.getRuleNode():e)):n}return t in e.siblings?e.siblings[t]:e.self[t]},has:(e,t)=>{const n=e.self[t],i=e.siblings[t];return void 0!==n||void 0!==i}});return n}executeEvent(e,t){let n;t&&(n=this.ruleEngine.execute(t,this.getExpressionScope(),e)),void 0!==n&&null!=n&&this.applyUpdates(n)}executeRule(e,t){void 0===e.payload.ruleName&&this.executeAllRules(t)}executeExpression(e){const t={form:this.form,$form:this.form.getRuleNode(),$field:this.getRuleNode(),field:this},n=this.ruleEngine.compileRule(e);return this.ruleEngine.execute(n,this.getExpressionScope(),t)}executeAction(e){const t={form:this.form,$form:this.form.getRuleNode(),$field:this.getRuleNode(),field:this,$event:{type:e.type,payload:e.payload,target:this.getRuleNode()}},n=e.isCustomEvent?`custom:${e.type}`:e.type,i=e.isCustomEvent?`custom_${e.type}`:e.type,s=this.getCompiledEvent(n);i in this&&"function"==typeof this[i]&&this[i](e,t),s.forEach((e=>this.executeEvent(t,e))),this.notifyDependents(e)}}class ne extends te{_children=[];_childrenReference;_itemTemplate=null;fieldFactory;constructor(e,t){super(e,{form:t.form,parent:t.parent}),this.fieldFactory=t.fieldFactory}ruleNodeReference(){return this._childrenReference}get items(){return this._children}get maxItems(){return this._jsonModel.maxItems}set maxItems(t){this._jsonModel.maxItems=t;const n=this._jsonModel.minItems||1,i=this._children.length,s=Math.min(i-t,i-n);if(s>0){for(let e=0;e<s;e++)this.getDataNode().$removeDataNode(t+e),this._childrenReference.pop();const n=this._children.splice(t,s);this.notifyDependents(e("items",n,null))}}get minItems(){return this._jsonModel.minItems}hasDynamicItems(){return null!=this._itemTemplate}get isContainer(){return!0}_activeChild=null;getState(){return{...super.getState(),items:this._children.map((e=>({...e.getState()})))}}_createChild(e,t){const{parent:n=this}=t;return this.fieldFactory.createField(e,{form:t.form,parent:n})}_addChildToRuleNode(e,t){const n=this,{parent:i=this}=t,s="array"==i.type?i._children.length+"":e.name||"";s.length>0&&Object.defineProperty(i._childrenReference,s,{get:()=>(e.isContainer&&e.hasDynamicItems()&&n.ruleEngine.trackDependency(e),n.hasDynamicItems()?(n.ruleEngine.trackDependency(n),void 0!==this._children[s]?this._children[s].getRuleNode():void 0):e.getRuleNode()),configurable:!0,enumerable:!0})}_addChild(e,t,n=!1){let i=this;for(;null!=i&&i.isTransparent();)i=i.parent;("number"!=typeof t||t>i._children.length)&&(t=this._children.length);const s=this.form,r={index:t,...H(e,n?()=>s.getUniqueId():void 0)},o=this._createChild(r,{parent:this,form:this.form});return this.form.fieldAdded(o),this._addChildToRuleNode(o,{parent:i}),t===this._children.length?this._children.push(o):this._children.splice(t,0,o),o}indexOf(e){return this._children.indexOf(e)}defaultDataModel(e){const t=this._jsonModel.type||void 0;if(void 0!==t){return new $(e,"array"===t?[]:{},t)}}_initialize(){super._initialize();const e=this._jsonModel.items||[];if(this._jsonModel.items=[],this._childrenReference="array"==this._jsonModel.type?[]:{},"array"==this._jsonModel.type&&1===e.length&&null!=this.getDataNode()){this._itemTemplate=H(e[0]),"number"!=typeof this._jsonModel.minItems&&(this._jsonModel.minItems=0),"number"!=typeof this._jsonModel.maxItems&&(this._jsonModel.maxItems=-1),"number"!=typeof this._jsonModel.initialItems&&(this._jsonModel.initialItems=Math.max(1,this._jsonModel.minItems));for(let e=0;e<this._jsonModel.initialItems;e++){this._addChild(this._itemTemplate)._initialize()}}else e.length>0?(e.forEach((e=>{this._addChild(e)._initialize()})),this._jsonModel.minItems=this._children.length,this._jsonModel.maxItems=this._children.length,this._jsonModel.initialItems=this._children.length):this.form.logger.warn("A container exists with no items.");this.setupRuleNode()}addItem(i){if(("addItem"===i.type||"addInstance"==i.type)&&null!=this._itemTemplate&&(-1===this._jsonModel.maxItems||this._children.length<this._jsonModel.maxItems)){const s=this.getDataNode();let r=i.payload;const o=this._addChild(this._itemTemplate,i.payload,!0);("number"!=typeof r||r>this._children.length)&&(r=this._children.length);const a=o.defaultDataModel(r);a&&s.$addDataNode(r,a),o._initialize(),this.notifyDependents(e("items",o.getState(),null)),o.dispatch(new n),o.dispatch(new t);for(let e=r+1;e<this._children.length;e++)this._children[e].dispatch(new t)}}removeItem(n){if(("removeItem"===n.type||"removeInstance"==n.type)&&null!=this._itemTemplate){if(0==this._children.length)return;let i=n.payload;"number"!=typeof i&&(i=this._children.length-1);const s=this._children[i].getState();if(this._children.length>this._jsonModel.minItems){this._childrenReference.pop(),this._children.splice(i,1),this.getDataNode().$removeDataNode(i);for(let e=i;e<this._children.length;e++)this._children[e].dispatch(new t);this.notifyDependents(e("items",null,s))}}}queueEvent(e){super.queueEvent(e),e.metadata?.dispatch&&this.items.forEach((t=>{t.queueEvent(e)}))}reset(){this.items.forEach((e=>{e.reset()}))}validate(){return this.items.flatMap((e=>e.validate())).filter((e=>""!==e.fieldName))}dispatch(e){super.dispatch(e)}importData(e){this._bindToDataModel(e);const t=this.getDataNode()||e;this.syncDataAndFormModel(t)}syncDataAndFormModel(e){if("array"===e?.$type&&null!=this._itemTemplate){const t=e?.$value.length,n=this._children.length,i=-1===this._jsonModel.maxItems?t:this._jsonModel.maxItems,s=this._jsonModel.minItems;let r=Math.min(t-n,i-n);const o=Math.min(n-t,n-s);for(;r>0;){r--;this._addChild(this._itemTemplate)._initialize()}if(o>0){this._children.splice(t,o);for(let e=0;e<o;e++)this._childrenReference.pop()}}this._children.forEach((t=>{t.importData(e)}))}get activeChild(){return this._activeChild}set activeChild(t){if(t!==this._activeChild){let n=this._activeChild;for(;n instanceof ne;){const e=n.activeChild;n.activeChild=null,n=e}const i=e("activeChild",t,this._activeChild);this._activeChild=t,this.parent&&null!==t&&(this.parent.activeChild=this),this._jsonModel.activeChild=t?.id,this.notifyDependents(i)}}}P([function(e,t,n){const i=n.get;null!=i&&(n.get=function(){return this.ruleEngine.trackDependency(this),i.call(this)})}],ne.prototype,"maxItems",null),P([function(e,t,n){const i=n.get;null!=i&&(n.get=function(){return this.ruleEngine.trackDependency(this),i.call(this)})}],ne.prototype,"minItems",null),P([function(e,t,n){const i=n.get;null!=i&&(n.get=function(){return this.ruleEngine.trackDependency(this),i.call(this)})}],ne.prototype,"activeChild",null);class ie{_jsonModel;constructor(e){this._jsonModel={...e}}getP(e,t){return((e,t,n)=>{if(t in e)return e[t];if(!t.startsWith(":")){const n=`:${t}`;if(n in e)return e[n]}return n})(this._jsonModel,e,t)}get isContainer(){return!1}}class se extends ie{get version(){return this.getP("version","")}get grammar(){return this.getP("grammar","")}}const re={off:0,debug:1,info:2,warn:3,error:4};class oe{debug(e){this.log(e,"debug")}info(e){this.log(e,"info")}warn(e){this.log(e,"warn")}error(e){this.log(e,"error")}log(e,t){0!==this.logLevel&&this.logLevel<=re[t]&&console[t](e)}logLevel;constructor(e="off"){this.logLevel=re[e]}}class ae{_node;_event;constructor(e,t){this._node=e,this._event=t}get node(){return this._node}get event(){return this._event}isEqual(e){return null!=e&&this._node==e._node&&this._event.type==e._event.type}toString(){return this._node.id+"__"+this.event.type}valueOf(){return this.toString()}}class le{logger;static MAX_EVENT_CYCLE_COUNT=10;_runningEventCount;_isProcessing=!1;_pendingEvents=[];constructor(e=new oe("off")){this.logger=e,this._runningEventCount={}}get length(){return this._pendingEvents.length}get isProcessing(){return this._isProcessing}isQueued(e,t){const n=new ae(e,t);return void 0!==this._pendingEvents.find((e=>n.isEqual(e)))}queue(e,t,n=!1){e&&t&&(t instanceof Array||(t=[t]),t.forEach((t=>{const i=new ae(e,t),s=this._runningEventCount[i.valueOf()]||0;if(s<le.MAX_EVENT_CYCLE_COUNT){if(this.logger.info(`Queued event : ${t.type} node: ${e.id} - ${e.name}`),n){const e=this._isProcessing?1:0;this._pendingEvents.splice(e,0,i)}else this._pendingEvents.push(i);this._runningEventCount[i.valueOf()]=s+1}else this.logger.info(`Skipped queueing event : ${t.type} node: ${e.id} - ${e.name} with count=${s}`)})))}runPendingQueue(){if(!this._isProcessing){for(this._isProcessing=!0;this._pendingEvents.length>0;){const e=this._pendingEvents[0];this.logger.info(`Dequeued event : ${e.event.type} node: ${e.node.id} - ${e.node.name}`),e.node.executeAction(e.event),this._pendingEvents.shift()}this._runningEventCount={},this._isProcessing=!1}}}class ue{data;mediaType="application/octet-stream";name="unknown";size=0;constructor(e){Object.assign(this,e)}get type(){return this.mediaType}toJSON(){return{name:this.name,size:this.size,mediaType:this.mediaType,data:this.data.toString()}}equals(e){return this.data===e.data&&this.mediaType===e.mediaType&&this.name===e.name&&this.size===e.size}}const he="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789_".split(""),de=/^(\d*\.?\d+)(\\?(?=[KMGT])([KMGT])(?:i?B)?|B?)$/i,ce=e=>{const t=[];for(let n=0;n<=e;n++){const e=Math.floor(Math.random()*he.length);t.push(he[e])}return t.join("")},pe=e=>{const t=e.items||[];return t?.reduce(((e,t)=>{let n=null;if(t.isContainer)n=pe(t);else if(Z(t.getState())){n={};const e=t.name||"",i=null!=t.dataRef?t.dataRef:e.length>0?t.name:void 0;t.value instanceof Array?n[t.id]=t.value.map((e=>({...e,dataRef:i}))):null!=t.value&&(n[t.id]={...t.value,dataRef:i})}return Object.assign(e,n)}),{})},me=e=>{let t=0;if("string"==typeof e){const n=de.exec(e.trim());null!=n&&(t=fe(parseFloat(n[1]),(n[2]||"kb").toUpperCase()))}return t},fe=(e,t)=>{const n=Math.pow(1024,{KB:1,MB:2,GB:3,TB:4}[t]);return Math.round(e*n)},ge=e=>null!=/^data:([a-z]+\/[a-z0-9-+.]+)?;(?:name=(.*);)?base64,(.*)$/.exec(e.trim()),_e=e=>{const t=/^data:([a-z]+\/[a-z0-9-+.]+)?(?:;name=([^;]+))?(;base64)?,(.+)$/.exec(e);if(null!==t){const e=t[1]||"",n=t[2]||"unknown";if("string"==typeof t[3]){const i=atob(t[4]),s=[];for(let e=0;e<i.length;e++)s.push(i.charCodeAt(e));return{name:n,blob:new window.Blob([new Uint8Array(s)],{type:e})}}return{name:n,blob:new window.Blob([t[4]],{type:e})}}return null},ye=(e,t=null,n={})=>{const i={...ve,...n},s="GET"===i.method&&t?be(e,t):e;return"GET"!==i.method&&(i.body=t),fetch(s,{...i}).then((async t=>{let n;t.ok?n=t?.headers?.get("Content-Type")?.includes("application/json")?await t.json():await t.text():(console.error(`Error fetching response from ${e} : ${t.statusText}`),n=t.statusText);const i={};return t?.headers?.forEach(((e,t)=>{i[t]=e})),{status:t.status,body:n,headers:i}}))},ve={method:"GET"},be=(e,t)=>{if(!t)return e;let n={};try{n=JSON.parse(t)}catch(e){console.log("Query params invalid")}const i=[];return Object.keys(n).forEach((e=>{Array.isArray(n[e])?i.push(`${encodeURIComponent(e)}=${encodeURIComponent(JSON.stringify(n[e]))}`):i.push(`${encodeURIComponent(e)}=${encodeURIComponent(n[e])}`)})),i.length?e.includes("?")?`${e}&${i.join("&")}`:`${e}?${i.join("&")}`:e},Me=e=>{const t=e;return t.length>0&&t.startsWith("custom:")?t.substring(7):t},je=async(e,t,n,s,r,o,a)=>{const l=t,u={method:n};let h,d;try{if(s&&s instanceof ue&&s.data instanceof File){const e=new FormData;e.append(s.name,s.data),d=e}else if(s instanceof FormData)d=s;else if(s&&"object"==typeof s&&Object.keys(s).length>0){const e=Object.keys(a);e.length>0?u.headers={...a,...-1===e.indexOf("Content-Type")?{"Content-Type":"application/json"}:{}}:u.headers={"Content-Type":"application/json"};const t=u?.headers?.["Content-Type"]||"application/json";"application/json"===t?d=JSON.stringify(s):t.indexOf("multipart/form-data")>-1?d=$e(s):t.indexOf("application/x-www-form-urlencoded")>-1&&(d=xe(s))}h=await ye(l,d,u)}catch(t){e.form.logger.error("Error invoking a rest API");const n=Me(o);return void e.form.dispatch(new i(n,{},!0))}const c=Me(r);e.form.dispatch(new i(c,h,!0))},xe=e=>{const t=new URLSearchParams;return Object.entries(e).forEach((([e,n])=>{null!=n&&"object"==typeof n?t.append(e,ee(n)):t.append(e,n)})),t},$e=(e,t)=>{const n=new FormData;Object.entries(e).forEach((([e,t])=>{null!=t&&"object"==typeof t?n.append(e,ee(t)):n.append(e,t)}));const i=(e,t)=>{if(e?.data instanceof File){let n=`${e?.dataRef}/${e?.name}`;n.startsWith("/")||(n=`/${n}`),t.append(n,e.data)}};return t&&Object.keys(t).reduce(((e,s)=>{const r=t[s];return r&&r instanceof Array?[...e,...r.map((e=>i(e,n)))]:[...e,i(r,n)]}),[]),n};const Ee=new class{customFunctions={};registerFunctions(e){Object.entries(e).forEach((([e,t])=>{let n=t;"function"==typeof t&&(n={_func:e=>t(...e),_signature:[]}),n.hasOwnProperty("_func")?this.customFunctions[e]=n:console.warn(`Unable to register function with name ${e}.`)}))}unregisterFunctions(...e){e.forEach((e=>{e in this.customFunctions&&delete this.customFunctions[e]}))}getFunctions(){function e(t){return null==t?t:null!==(n=t)&&"[object Array]"===Object.prototype.toString.call(n)?t.map((t=>e(t))):t.valueOf();var n}function t(e){return null==e?"":e.toString()}return{...{validate:{_func:(e,t,n)=>{const i=e[0];let s;return s="string"==typeof i||void 0===i?n.globals.form.validate():n.globals.form.getElement(i.$id).validate(),Array.isArray(s)&&s.length&&n.globals.form.logger.error("Form Validation Error"),s},_signature:[]},setFocus:{_func:(e,t,n)=>{const i=e[0];try{const e=n.globals.form.getElement(i.$id);n.globals.form.setFocus(e)}catch(e){n.globals.form.logger.error("Invalid argument passed in setFocus. An element is expected")}},_signature:[]},getData:{_func:(e,t,n)=>(n.globals.form.logger.warn("The `getData` function is depricated. Use `exportData` instead."),n.globals.form.exportData()),_signature:[]},exportData:{_func:(e,t,n)=>n.globals.form.exportData(),_signature:[]},importData:{_func:(e,t,n)=>{const i=e[0];return"object"==typeof i&&null!==i&&n.globals.form.importData(i),{}},_signature:[]},submitForm:{_func:(n,i,r)=>{const o=t(n[0]),a=t(n[1]),l=n.length>2?t(n[2]):"multipart/form-data",u=n.length>3?e(n[3]):null;return r.globals.form.dispatch(new s({success:o,error:a,submit_as:l,data:u})),{}},_signature:[]},request:{_func:(n,i,s)=>{const r=t(n[0]),o=t(n[1]),a=e(n[2]);let l,u,h={};return"string"==typeof n[3]?(s.globals.form.logger.warn("This usage of request is deprecated. Please see the documentation and update"),l=e(n[3]),u=e(n[4])):(h=e(n[3]),l=e(n[4]),u=e(n[5])),je(s.globals,r,o,a,l,u,h),{}},_signature:[]},dispatchEvent:{_func:(t,n,c)=>{const p=t[0];let m,f=e(t[1]),g=t.length>2?e(t[2]):void 0,_=!1;return"string"==typeof p&&(g=f,f=p,_=!0),m=f.startsWith("custom:")?new i(f.substring(7),g,_):((e,t={})=>{switch(e){case"change":return new d(t);case"submit":return new s(t);case"click":return new h(t);case"addItem":return new u(t);case"removeItem":return new l(t);case"reset":return new a(t);case"addInstance":return new o(t);case"removeInstance":return new r(t);default:console.error("invalid action")}})(f,g),null!=m&&("string"==typeof p?c.globals.form.dispatch(m):c.globals.form.getElement(p.$id).dispatch(m)),{}},_signature:[]}},...this.customFunctions}}};class we extends ne{_ruleEngine;_eventQueue;_fields={};_ids;_invalidFields=[];_logger;constructor(e,i,s,r=new le,o="off"){super(e,{fieldFactory:i}),this._ruleEngine=s,this._eventQueue=r,this._logger=new oe(o),this.queueEvent(new n),this.queueEvent(new t),this._ids=function*(e=50){const t=function(){const t=[];for(let n=0;n<e;n++)t.push(ce(10));return t},n={};let i=t();do{let e=i.pop();for(;e in n;)0===i.length&&(i=t()),e=i.pop();n[e]=!0,yield i.pop(),0===i.length&&(i=t())}while(i.length>0)}(),this._bindToDataModel(new $("$form",{})),this._initialize(),this.queueEvent(new c)}get logger(){return this._logger}dataRefRegex=/("[^"]+?"|[^.]+?)(?:\.|$)/g;get metaData(){const e=this._jsonModel.metadata||{};return new se(e)}get action(){return this._jsonModel.action}get lang(){return this._jsonModel.lang||"en"}importData(e){this._bindToDataModel(new $("$form",e)),this.syncDataAndFormModel(this.getDataNode()),this._eventQueue.runPendingQueue()}exportData(){return this.getDataNode()?.$value}setFocus(e){const t=e.parent,n=e;for(;null!=t&&t.activeChild!=n;)t.activeChild=n}getState(){const e=this,t=super.getState();return t.id="$form",Object.defineProperty(t,"data",{get:function(){return e.exportData()}}),Object.defineProperty(t,"attachments",{get:function(){return pe(e)}}),t}get type(){return"object"}isTransparent(){return!1}get form(){return this}get ruleEngine(){return this._ruleEngine}getUniqueId(){return null==this._ids?"":this._ids.next().value}fieldAdded(e){this._fields[e.id]=e,e.subscribe((e=>{-1===this._invalidFields.indexOf(e.target.id)&&this._invalidFields.push(e.target.id)}),"invalid"),e.subscribe((e=>{const t=this._invalidFields.indexOf(e.target.id);t>-1&&this._invalidFields.splice(t,1)}),"valid"),e.subscribe((e=>{const t=e.target.getState();if(t){const n=new p(e.payload.changes,t);this.dispatch(n)}}))}visit(e){this.traverseChild(this,e)}traverseChild(e,t){e.items.forEach((e=>{e.isContainer&&this.traverseChild(e,t),t(e)}))}validate(){const e=super.validate();return this.dispatch(new m(e)),e}isValid(){return 0===this._invalidFields.length}dispatch(e){"submit"===e.type?(super.queueEvent(e),this._eventQueue.runPendingQueue()):super.dispatch(e)}submit(e,t){if(0===this.validate().length){const n=e?.payload||{};(async(e,t,n,i="multipart/form-data",s=null)=>{const r=e.form.action;let o=s;"object"==typeof o&&null!=o||(o=e.form.exportData());const a=pe(e.form);let l=i;const u={data:o,submitMetadata:{lang:e.form.lang}};let h=u;(Object.keys(a).length>0||"multipart/form-data"===i)&&(h=$e(u,a),l="multipart/form-data"),await je(e,r,"POST",h,t,n,{"Content-Type":l})})(t,n?.success,n?.error,n?.submit_as,n?.data)}}reset(){super.reset(),this._invalidFields=[]}getElement(e){return e==this.id?this:this._fields[e]}get qualifiedName(){return"$form"}getEventQueue(){return this._eventQueue}get name(){return"$form"}get value(){return null}get id(){return"$form"}get title(){return this._jsonModel.title||""}}class De{_context;_globalNames=["$form","$field","$event"];formulaEngine;debugInfo=[];constructor(){const e=Ee.getFunctions();this.formulaEngine=new _(e,void 0,this.debugInfo)}compileRule(e){return this.formulaEngine.compile(e,this._globalNames)}execute(e,t,n,i=!1){const s=this._context;let r;this._context=n;try{r=this.formulaEngine.run(e,t,"en-US",n)}catch(e){this._context?.form?.logger?.error(e)}for(;this.debugInfo.length>0;)this._context?.form?.logger?.debug(this.debugInfo.pop());let o=r;return i&&"object"==typeof r&&null!==r&&(o=Object.getPrototypeOf(r).valueOf.call(r)),this._context=s,o}trackDependency(e){this._context&&void 0!==this._context.field&&this._context.field!==e&&e._addDependent(this._context.field)}}const Ne={visible:!0,enabled:!0};class Te extends ne{constructor(e,i){super(e,i),this._applyDefaults(),this.queueEvent(new n),this.queueEvent(new t)}_applyDefaults(){Object.entries(Ne).map((([e,t])=>{void 0===this._jsonModel[e]&&(this._jsonModel[e]=t)})),this._jsonModel.dataRef&&void 0===this._jsonModel.type&&(this._jsonModel.type="object")}get type(){const e=super.type;if("array"===e||"object"===e)return e}get items(){return super.items}get value(){return null}get fieldType(){return"panel"}get enabled(){return this._jsonModel.enabled}set enabled(e){this._setProperty("enabled",e)}}class Oe extends Te{get maxOccur(){return this._jsonModel.maxItems}set maxOccur(e){this.maxItems=e}get minOccur(){return this.minItems}addInstance(e){return this.addItem(e)}removeInstance(e){return this.removeItem(e)}}P([function(e,t,n){const i=n.get;null!=i&&(n.get=function(){return this.ruleEngine.trackDependency(this),i.call(this)})}],Oe.prototype,"maxOccur",null),P([function(e,t,n){const i=n.get;null!=i&&(n.get=function(){return this.ruleEngine.trackDependency(this),i.call(this)})}],Oe.prototype,"minOccur",null);class ke{fieldName;errorMessages;constructor(e="",t=[]){this.errorMessages=t,this.fieldName=e}}const Ie=/^(\d{4})-(\d{1,2})-(\d{1,2})$/,Re=[31,28,31,30,31,30,31,31,30,31,30,31],Fe=e=>{if(""===e||null==e)return{value:"",valid:!0};let t=parseFloat(e);const n=!isNaN(t);return n||(t=e),{value:t,valid:n}},Ce=e=>{if(""==e||null==e)return{value:"",valid:!0};let t=parseFloat(e);const n=!isNaN(t)&&Math.round(t)===t;return n||(t=e),{value:t,valid:n}},Pe=e=>null==e||e instanceof Array?e:[e],Se=e=>{const t="boolean"==typeof e||"true"===e||"false"===e;return{valid:t,value:"boolean"==typeof e?e:t?"true"===e:e}},qe=e=>{const t=(e=>{if(null!==e){let t=null;if(e instanceof ue)t=e;else if("undefined"!=typeof File&&e instanceof File)t={name:e.name,mediaType:e.type,size:e.size,data:e};else if("string"==typeof e&&ge(e)){const n=_e(e);if(null!==n){const{blob:e,name:i}=n;t={name:i,mediaType:e.type,size:e.size,data:e}}}else{let n=e;try{n=JSON.parse(e),t=n,t.mediaType||(t.mediaType=t.type)}catch(e){}if("string"==typeof n?.data&&ge(n?.data)){const e=_e(n?.data);if(null!==e){const i=e.blob;t={name:n?.name,mediaType:n?.type||n?.mediaType,size:i.size,data:i}}}else"string"==typeof n?t={name:n.split("/").pop(),mediaType:"application/octet-stream",size:0,data:n}:"object"==typeof n&&(t={name:n?.name,mediaType:n?.type||n?.mediaType,size:n?.size,data:n?.data})}return null!==t&&null!=t.data?new ue(t):null}return null})(e),n=null!==t;return{value:n?t:e,valid:n}},Ae=(e,t)=>{const n=Pe(e);return null==n?[[],[n]]:n.reduce(((e,n)=>{if(0==e[1].length){const i=t(n);e[i.valid?0:1].push(i.value)}return e}),[[],[]])},ze={date:["minimum","maximum","exclusiveMinimum","exclusiveMaximum","format"],string:["minLength","maxLength","pattern"],number:["minimum","maximum","exclusiveMinimum","exclusiveMaximum"],array:["minItems","maxItems","uniqueItems"],file:["accept","maxFileSize"]},Ve={type:(e,t)=>{let n=t;if(null==t)return{valid:!0,value:t};let i,s=!0;switch(e){case"string":s=!0,n=t.toString();break;case"string[]":n=Pe(t);break;case"number":i=Fe(t),n=i.value,s=i.valid;break;case"boolean":i=Se(t),s=i.valid,n=i.value;break;case"integer":i=Ce(t),s=i.valid,n=i.value;break;case"integer[]":i=Ae(t,Ce),s=0===i[1].length,n=s?i[0]:t;break;case"file":i=qe(t instanceof Array?t[0]:t),s=i.valid,n=i.value;break;case"file[]":i=Ae(t,qe),s=0===i[1].length,n=s?i[0]:t;break;case"number[]":i=Ae(t,Fe),s=0===i[1].length,n=s?i[0]:t;break;case"boolean[]":i=Ae(t,Se),s=0===i[1].length,n=s?i[0]:t}return{valid:s,value:n}},format:(e,t)=>{let n=!0;const i=t;if(null===t)return{value:i,valid:n};let s;switch(e){case"date":if(s=Ie.exec((t||"").trim()),null!=s){const[e,t,i,r]=s,[o,a]=[+i,+r],l=(e=>e%400==0||e%4==0&&e%100!=0)(+t);n=o>=1&&o<=12&&a>=1&&a<=((e,t)=>e&&2==t?29:Re[t-1])(l,o)}else n=!1;break;case"data-url":n=!0}return{valid:n,value:i}},minimum:(e,t)=>({valid:t>=e,value:t}),maximum:(e,t)=>({valid:t<=e,value:t}),exclusiveMinimum:(e,t)=>({valid:t>e,value:t}),exclusiveMaximum:(e,t)=>({valid:t<e,value:t}),minItems:(e,t)=>({valid:t instanceof Array&&t.length>=e,value:t}),maxItems:(e,t)=>({valid:t instanceof Array&&t.length<=e,value:t}),uniqueItems:(e,t)=>({valid:!e||t instanceof Array&&t.length===new Set(t).size,value:t}),minLength:(e,t)=>({...Ve.minimum(e,"string"==typeof t?t.length:0),value:t}),maxLength:(e,t)=>({...Ve.maximum(e,"string"==typeof t?t.length:0),value:t}),pattern:(e,t)=>{let n;return n="string"==typeof e?new RegExp(e):e,{valid:n.test(t),value:t}},required:(e,t)=>({valid:!e||null!=t&&""!==t,value:t}),enum:(e,t)=>({valid:e.indexOf(t)>-1,value:t}),accept:(e,t)=>{if(!e||0===e.length||null==t)return{valid:!0,value:t};return{valid:!(t instanceof Array?t:[t]).some((t=>{return n=t.type,i=e,!(!n||i.some((e=>{const t=e.trim(),i=t.split("/")[0],s=t.split(".")[1];return t.includes("*")&&n.startsWith(i)||t.includes(".")&&n.endsWith(s)||t===n})));var n,i})),value:t}},maxFileSize:(e,t)=>{const n="string"==typeof e?me(e):e;return{valid:!(t instanceof ue)||t.size<=n,value:t}}},Ue=["string","number","boolean","file","string[]","number[]","boolean[]","file[]","array","object"];class Le extends te{constructor(e,i){super(e,i),this._applyDefaults(),this.queueEvent(new n),this.queueEvent(new t)}_ruleNodeReference=[];_initialize(){super._initialize(),this.setupRuleNode()}ruleNodeReference(){return this.type?.endsWith("[]")?this._ruleNodeReference=[]:this._ruleNodeReference=this,this._ruleNodeReference}_getDefaults(){return{readOnly:!1,enabled:!0,visible:!0,type:this._getFallbackType()}}_getFallbackType(){const e=this._jsonModel.type;let t=e;if("string"!=typeof e||-1===Ue.indexOf(e)){const e=this.enum;if(t=typeof e?.[0],"undefined"===t&&void 0!==this._jsonModel.default&&(t=this._jsonModel.default instanceof Array&&this._jsonModel.default.length>0?typeof this._jsonModel.default[0]+"[]":typeof this._jsonModel.default),0===t.indexOf("undefined")){t={"text-input":"string","multiline-input":"string","number-input":"number","date-input":"string","plain-text":"string",image:"string",checkbox:"boolean"}[this.fieldType]}}return t}_applyDefaults(){Object.entries(this._getDefaults()).map((([e,t])=>{void 0===this._jsonModel[e]&&void 0!==t&&(this._jsonModel[e]=t)})),this.coerceParam("required","boolean"),this.coerceParam("readOnly","boolean"),this.coerceParam("enabled","boolean");const e=this._jsonModel.type;"string"==typeof e&&-1!==Ue.indexOf(e)||(this._jsonModel.type=this._getFallbackType()),-1===["plain-text","image"].indexOf(this.fieldType)&&(this._jsonModel.value=void 0);if(void 0===this._jsonModel.value){const e=Ve.type(this.getInternalType()||"string",this._jsonModel.default);this._jsonModel.value=e.value}if("string"!==this._jsonModel.type&&this.unset("emptyValue"),void 0===this._jsonModel.fieldType&&(this.form.logger.error("fieldType property is mandatory. Please ensure all the fields have a fieldType"),this._jsonModel.viewType?(this._jsonModel.viewType.startsWith("custom:")?this.form.logger.error("viewType property has been removed. For custom types, use :type property"):this.form.logger.error("viewType property has been removed. Use fieldType property"),this._jsonModel.fieldType=this._jsonModel.viewType):this._jsonModel.fieldType=Y(this._jsonModel)),void 0===this._jsonModel.enum){"boolean"===this._jsonModel.type&&(this._jsonModel.enum=[!0,!1])}else for(void 0===this._jsonModel.enumNames&&(this._jsonModel.enumNames=this._jsonModel.enum.map((e=>e.toString())));this._jsonModel.enumNames.length<this._jsonModel.enum.length;)this._jsonModel.enumNames.push(this._jsonModel.enum[this._jsonModel.enumNames.length].toString());const t=["minimum","maximum","exclusiveMinimum","exclusiveMaximum"];"string"!==this._jsonModel.type?this.unset("format","pattern","minLength","maxLength"):"date-input"===this._jsonModel.fieldType&&(this._jsonModel.format="date"),this.coerceParam("minLength","number"),this.coerceParam("maxLength","number"),"number"!==this._jsonModel.type&&"date"!==this._jsonModel.format&&this.unset("step",...t),t.forEach((e=>{this.coerceParam(e,this._jsonModel.type)})),"number"!=typeof this._jsonModel.step&&this.coerceParam("step","number")}unset(...e){e.forEach((e=>this._jsonModel[e]=void 0))}coerceParam(e,t){const n=this._jsonModel[e];if(void 0!==n&&typeof n!==t){this.form.logger.info(`${e} is not of type ${t}. Trying to coerce.`);try{this._jsonModel[e]=((e,t)=>{let n;switch(t){case"string":return e+"";case"number":if(n=+e,!isNaN(n))return n;break;case"boolean":if("string"==typeof e)return"true"===e;if("number"==typeof e)return 0!==e}throw`${e} has invalid type. Expected : ${t}, Actual ${typeof e}`})(n,t)}catch(t){this.form.logger.warn(t),this.unset(e)}}}get editFormat(){return this.withCategory(this._jsonModel.editFormat)}get displayFormat(){return this.withCategory(this._jsonModel.displayFormat)}get placeholder(){return this._jsonModel.placeholder}get readOnly(){return this._jsonModel.readOnly}set readOnly(e){this._setProperty("readOnly",e)}get enabled(){return this._jsonModel.enabled}set enabled(e){this._setProperty("enabled",e)}get valid(){return this._jsonModel.valid}get emptyValue(){return"null"===this._jsonModel.emptyValue?null:""===this._jsonModel.emptyValue&&"string"===this.type?"":void 0}get enum(){return this._jsonModel.enum}set enum(e){this._setProperty("enum",e)}get enumNames(){return this._jsonModel.enumNames}set enumNames(e){this._setProperty("enumNames",e)}get required(){return this._jsonModel.required||!1}set required(e){this._setProperty("required",e)}get maximum(){if("number"===this.type||"date"===this.format)return this._jsonModel.maximum}set maximum(e){"number"!==this.type&&"date"!==this.format||this._setProperty("maximum",e)}get minimum(){if("number"===this.type||"date"===this.format)return this._jsonModel.minimum}set minimum(e){"number"!==this.type&&"date"!==this.format||this._setProperty("minimum",e)}isEmpty(){return void 0===this._jsonModel.value||null===this._jsonModel.value||""===this._jsonModel.value}withCategory(e){if(e){const t=e?.match(/^(?:date|num)\|/);if(null===t)return"date"===this.format?e=`date|${e}`:"number"===this.type&&(e=`num|${e}`),e}return e}get editValue(){const e=this.editFormat;if(!e||!this.isNotEmpty(this.value)||!1===this.valid)return this.value;try{return y(this.value,this.language,e)}catch(e){return this.value}}get displayValue(){const e=this.displayFormat;if(!e||!this.isNotEmpty(this.value)||!1===this.valid)return this.value;try{return y(this.value,this.language,e)}catch(e){return this.value}}getDataNodeValue(e){return this.isEmpty()?this.emptyValue:e}updateDataNodeAndTypedValue(e){const t=this.getDataNode();if(A.indexOf(this.fieldType)>-1&&void 0!==t)return;const n=this._getConstraintObject().type(this.getInternalType()||"string",e),i=this._setProperty("value",n.value,!1);return i.length>0&&(this._updateRuleNodeReference(n.value),void 0!==t&&t.setValue(this.getDataNodeValue(this._jsonModel.value),this._jsonModel.value,this)),i}get value(){return void 0===this._jsonModel.value?null:this._jsonModel.value}set value(e){const t=this.updateDataNodeAndTypedValue(e);let n={valid:!0};if(t?.length>0){let i={};const s=Ve.type(this.getInternalType()||"string",e);if(this.parent.uniqueItems&&"array"===this.parent.type&&(n=Ve.uniqueItems(this.parent.uniqueItems,this.parent.getDataNode().$value)),s.valid&&n.valid)i=this.evaluateConstraints();else{const e={valid:s.valid&&n.valid,errorMessage:s.valid&&n.valid?"":this.getErrorMessage("type")};i=this._applyUpdates(["valid","errorMessage"],e)}i.valid&&this.triggerValidationEvent(i);const r=new d({changes:t.concat(Object.values(i))});this.dispatch(r)}}reset(){const e=this.updateDataNodeAndTypedValue(this.default);if(e.length>0){const t={valid:void 0,errorMessage:""},n=this._applyUpdates(["valid","errorMessage"],t),i=new d({changes:e.concat(Object.values(n))});this.dispatch(i)}}_updateRuleNodeReference(e){if(this.type?.endsWith("[]"))if(null!=e)for(e.forEach(((e,t)=>{this._ruleNodeReference[t]=e}));e.length!==this._ruleNodeReference.length;)this._ruleNodeReference.pop();else for(;0!==this._ruleNodeReference.length;)this._ruleNodeReference.pop()}getInternalType(){return this.type}valueOf(){const e=this[V],t=void 0===e?this:e;return t.ruleEngine.trackDependency(t),t._jsonModel.value||null}toString(){const e=this[V],t=void 0===e?this:e;return t._jsonModel.value?.toString()||""}getErrorMessage(e){return this._jsonModel.constraintMessages?.[e]||""}get errorMessage(){return this._jsonModel.errorMessage}get screenReaderText(){return this._jsonModel.screenReaderText}_getConstraintObject(){return Ve}isArrayType(){return!!this.type&&this.type.indexOf("[]")>-1}checkEnum(e,t){if(!0===this._jsonModel.enforceEnum&&null!=e){const n=t.enum;return e instanceof Array&&this.isArrayType()?e.every((e=>n(this.enum||[],e).valid)):n(this.enum||[],e).valid}return!0}checkStep(){const e=this._jsonModel.value,t=this._jsonModel.step;if("number"==typeof t){const n=t.toString().split(".")?.[1]?.length||0,i=Math.pow(10,n),s=t*i,r=e*i,o=(this._jsonModel.minimum||this._jsonModel.default||0)*i,a=(r-o)/s,l=Math.abs(r-o)%s<.001;let u,h;return l||(u=(Math.ceil(a)*s+o)/i,h=(u-s)/i),{valid:l,next:u,prev:h}}return{valid:!0}}checkValidationExpression(){return"string"!=typeof this._jsonModel.validationExpression||this.executeExpression(this._jsonModel.validationExpression)}getConstraints(){switch(this.type){case"string":switch(this.format){case"date":return ze.date;case"binary":case"data-url":return ze.file;default:return ze.string}case"file":return ze.file;case"number":case"integer":return ze.number}return this.isArrayType()?ze.array:[]}get format(){if(void 0===this._jsonModel.format&&"string"===this.type)switch(this.fieldType){case"date-input":this._jsonModel.format="date";break;case"file-input":this._jsonModel.format="data-url"}return this._jsonModel.format}get enforceEnum(){return this._jsonModel.enforceEnum}get tooltip(){return this._jsonModel.tooltip}get maxLength(){return this._jsonModel.maxLength}get minLength(){return this._jsonModel.minLength}get pattern(){return this._jsonModel.pattern}get step(){if("number"===this.type||"date"===this.format)return this._jsonModel.step}get exclusiveMinimum(){if("number"===this.type||"date"===this.format)return this._jsonModel.exclusiveMinimum}set exclusiveMinimum(e){"number"!==this.type&&"date"!==this.format||(this._jsonModel.exclusiveMinimum=e)}get exclusiveMaximum(){if("number"===this.type||"date"===this.format)return this._jsonModel.exclusiveMaximum}set exclusiveMaximum(e){"number"!==this.type&&"date"!==this.format||(this._jsonModel.exclusiveMaximum=e)}get default(){return this._jsonModel.default}isNotEmpty(e){return null!=e&&""!==e}evaluateConstraints(){let e="type";const t=this._jsonModel,n=this._jsonModel.value,i=this._getConstraintObject(),s=this.getConstraints();let r=!0;if(r&&(r=i.required(this.required,n).valid&&(!this.isArrayType()||!this.required||n.length>0),e="required"),r&&this.isNotEmpty(n)){const o=s.find((e=>{if(e in t&&void 0!==t[e]){const s=t[e],r=i[e];return n instanceof Array&&this.isArrayType()?-1!==ze.array.indexOf(e)?!r(s,n).valid:n.some((e=>!r(s,e).valid)):"function"==typeof r&&!r(s,n).valid}return!1}));null!=o?(r=!1,e=o):(r=this.checkEnum(n,i),e="enum",r&&"number"===this.type&&(r=this.checkStep().valid,e="step"),r&&(r=this.checkValidationExpression(),e="validationExpression"))}r||this.form.logger.info(`${e} constraint evaluation failed ${this._jsonModel[e]}. Received ${this._jsonModel.value}`);const o={valid:r,errorMessage:r?"":this.getErrorMessage(e)};return this._applyUpdates(["valid","errorMessage"],o)}triggerValidationEvent(e){e.valid&&(this.valid?this.dispatch(new f):this.dispatch(new g))}validate(){const e=this.evaluateConstraints();return e.valid&&(this.triggerValidationEvent(e),this.notifyDependents(new d({changes:Object.values(e)}))),this.valid?[]:[new ke(this.id,[this._jsonModel.errorMessage])]}importData(t){this._bindToDataModel(t);const n=this.getDataNode();if(void 0!==n&&n!==x&&n.$value!==this._jsonModel.value){const t=e("value",n.$value,this._jsonModel.value);this._jsonModel.value=n.$value,this.queueEvent(t)}}defaultDataModel(e){const t=A.indexOf(this.fieldType)>-1?void 0:this.getDataNodeValue(this._jsonModel.value);return new M(e,t,this.type||"string")}getState(){return{...super.getState(),editFormat:this.editFormat,displayFormat:this.displayFormat,editValue:this.editValue,displayValue:this.displayValue}}}function Qe(e,t){return e.replace(";base64",`;name=${encodeURIComponent(t)};base64`)}async function We(e){const{name:t,size:n,type:i}=e;return await new Promise(((s,r)=>{const o=new FileReader;o.onload=e=>{s(new ue({data:Qe(e.target.result,t),type:i,name:t,size:n}))},o.readAsDataURL(e.data)}))}P([function(e,t,n){const i=n.get;null!=i&&(n.get=function(){return this.ruleEngine.trackDependency(this),i.call(this)})},W("button","image","plain-text")],Le.prototype,"readOnly",null),P([function(e,t,n){const i=n.get;null!=i&&(n.get=function(){return this.ruleEngine.trackDependency(this),i.call(this)})},W("image","plain-text")],Le.prototype,"enabled",null),P([function(e,t,n){const i=n.get;null!=i&&(n.get=function(){return this.ruleEngine.trackDependency(this),i.call(this)})}],Le.prototype,"valid",null),P([function(e,t,n){const i=n.get;null!=i&&(n.get=function(){return this.ruleEngine.trackDependency(this),i.call(this)})}],Le.prototype,"enum",null),P([function(e,t,n){const i=n.get;null!=i&&(n.get=function(){return this.ruleEngine.trackDependency(this),i.call(this)})}],Le.prototype,"enumNames",null),P([function(e,t,n){const i=n.get;null!=i&&(n.get=function(){return this.ruleEngine.trackDependency(this),i.call(this)})}],Le.prototype,"required",null),P([Q("date-input","number-input")],Le.prototype,"editValue",null),P([function(e,t,n){const i=n.get;null!=i&&(n.get=function(){return this.ruleEngine.trackDependency(this),i.call(this)})}],Le.prototype,"value",null),P([Q("text-input","date-input","file-input")],Le.prototype,"format",null),P([Q("text-input")],Le.prototype,"maxLength",null),P([Q("text-input")],Le.prototype,"minLength",null),P([Q("text-input")],Le.prototype,"pattern",null),P([function(e,t,n){const i=n.get;null!=i&&(n.get=function(){return this.ruleEngine.trackDependency(this),i.call(this)})}],Le.prototype,"exclusiveMinimum",null),P([function(e,t,n){const i=n.get;null!=i&&(n.get=function(){return this.ruleEngine.trackDependency(this),i.call(this)})}],Le.prototype,"exclusiveMaximum",null);class Be extends Le{_getDefaults(){return{...super._getDefaults(),accept:["audio/*","video/*","image/*","text/*","application/pdf"],maxFileSize:"2MB"}}_getFallbackType(){return"file"}get maxFileSize(){return me(this._jsonModel.maxFileSize)}get accept(){return this._jsonModel.accept}_applyUpdates(e,t){return e.reduce(((e,n)=>{const i=this._jsonModel[n],s=t[n];return s!==i&&(e[n]={propertyName:n,currentValue:s,prevValue:i},this._jsonModel[n]=i instanceof ue&&"object"==typeof s&&"value"===n?new ue({...i,data:s.data}):s),e}),{})}getInternalType(){return this.type?.endsWith("[]")?"file[]":"file"}getDataNodeValue(e){let t=e;return null!=t&&("string"===this.type?t=t.data?.toString():"string[]"===this.type&&(t=t instanceof Array?t:[t],t=t.map((e=>e?.data?.toString())))),t}async _serialize(){const e=this._jsonModel.value;if(void 0===e)return null;var t;return await(t=e instanceof Array?e:[e],Promise.all([].map.call(t,We)))}importData(t){this._bindToDataModel(t);const n=this.getDataNode();if(void 0!==n){const t=n?.$value;if(null!=t){const n=Ve.type(this.getInternalType(),t);n.valid||this.form.logger.error(`unable to bind ${this.name} to data`),this.form.getEventQueue().queue(this,e("value",n.value,this._jsonModel.value)),this._jsonModel.value=n.value}else this._jsonModel.value=null}}}class Ge extends Le{offValue(){const e=this.enum;return e.length>1?e[1]:null}_getConstraintObject(){const e={...super._getConstraintObject()};var t;return e.required=(t=this.offValue(),(e,n)=>({valid:Ve.required(e,n).valid&&(!e||n!=t),value:n})),e}_getDefaults(){return{...super._getDefaults(),enforceEnum:!0}}get enum(){return this._jsonModel.enum||[]}}class Je extends Le{constructor(e,t){super(e,t)}_getFallbackType(){const e=super._getFallbackType();return"string"==typeof e?`${e}[]`:"string[]"}_getDefaults(){return{...super._getDefaults(),enforceEnum:!0,enum:[]}}}class Ke extends Le{_applyDefaults(){super._applyDefaults();const e=(new Intl.DateTimeFormat).resolvedOptions().locale;this._jsonModel.editFormat||(this._jsonModel.editFormat="short"),this._jsonModel.displayFormat||(this._jsonModel.displayFormat=this._jsonModel.editFormat),this._jsonModel.placeholder||(this._jsonModel.placeholder=v(this._jsonModel.editFormat,e)),this._jsonModel.description||(this._jsonModel.description=`To enter today's date use ${b(new Date,e,this._jsonModel.editFormat)}`)}}const Xe={text:"text-input",number:"number-input",email:"text-input",file:"file-input",range:"range",textarea:"multiline-input"};const Ye=new class{createField(e,t){let n;const i={...t,fieldFactory:this};if(e.fieldType=e.fieldType?e.fieldType in Xe?Xe[e.fieldType]:e.fieldType:"text-input",(r=e).repeatable&&(void 0===r.minOccur&&void 0===r.maxOccur||void 0!==r.minOccur&&void 0!==r.maxOccur&&0!==r.maxOccur||void 0!==r.minOccur&&void 0!==r.maxOccur&&0!==r.minOccur&&0!==r.maxOccur||void 0!==r.minOccur&&r.minOccur>=0||void 0!==r.maxOccur&&0!==r.maxOccur)){const t={...e,..."items"in e&&{type:"object"},minOccur:void 0,maxOccur:void 0,repeatable:void 0,name:void 0},s={minItems:e.minOccur||0,maxItems:e.maxOccur||-1,fieldType:e.fieldType,type:"array",name:e.name,dataRef:e.dataRef,items:[t]};n=new Oe(s,i)}else"items"in e?n=new Te(e,i):Z(e)||"file-input"===e.fieldType?n=new Be(e,i):(s=e,n="checkbox"===(s?.fieldType||Y(s))?new Ge(e,i):function(e){return"checkbox-group"===(e?.fieldType||Y(e))}(e)?new Je(e,i):function(e){const t=e?.fieldType||Y(e);return"text-input"===t&&"date"===e?.format||"date-input"===t}(e)?new Ke(e,i):new Le(e,i));var s,r;return n}},Ze=(e,t,n="error",i=void 0)=>{try{let s=i;null==s&&(s=new we({...e},Ye,new De,new le(new oe(n)),n));const r=e?.data;return r&&s.importData(r),"function"==typeof t&&t(s),s.getEventQueue().runPendingQueue(),s}catch(e){throw console.error(`Unable to create an instance of the Form ${e}`),new Error(e)}},He=(e,t)=>{try{const n=new we({...e},Ye,new De);return t&&n.importData(t),0===n.validate().length}catch(e){throw new Error(e)}},et=(e,t)=>{try{const n=new we({...e},Ye,new De);t&&n.importData(t);const i=n.validate();return{messages:i,valid:0===i.length}}catch(e){throw new Error(e)}},tt=(e,t={})=>{const n=new Headers;return Object.entries(t).forEach((([e,t])=>{n.append(e,t)})),new Promise(((n,i)=>{ye(`${e}.model.json`,null,{headers:t}).then((e=>{if(200!==e.status)i("Not Found");else{let t=e.body;if("model"in t){const{model:e}=t;t=e}n(ee(t))}}))}))},nt=e=>{Ee.registerFunctions(e)};export{Ze as createFormInstance,tt as fetchForm,nt as registerFunctions,et as validateFormData,He as validateFormInstance};
